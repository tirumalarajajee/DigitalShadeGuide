<!DOCTYPE html>


<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tooth Shade Detection</title>
<link rel="manifest" href="manifest.json" />
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; }
    #camera { display: none; } /* hidden video stream */
    #snapshot { border: 1px solid #000; display: block; margin: 10px auto; }
    #confidenceFill {
      height: 20px;
      background: gray;
      width: 100px;
      margin: auto;
      color: white;
      line-height: 20px;
    }
  </style>
</head>
<body>
  <h2>🦷 Detection Mode</h2>
  <video id="camera" autoplay playsinline width="640" height="480"></video>
  <canvas id="snapshot" width="640" height="480"></canvas>
<!-- Add this input for dynamic patient naming -->
<input type="text" id="patientNameInput" placeholder="Enter patient name" />

  <br />
  <label for="modeSelector">Detection Mode:</label>
  <select id="modeSelector">
    <option value="single">Single</option>
    <option value="region">Region</option>
    <option value="merge">Merged</option>
  </select>

  <p id="liveShade">Shade: ---</p>
  <div id="confidenceFill">ΔE00: ---</div>
<p id="licenseStatus" style="color: red;">🔒 License not active</p>
<p id="trialCountdown">Trial time left: 15:00</p>


  <br />
  <button id="saveSingle">Save Single</button>
  <button id="saveRegion">Save Region</button>
  <button id="saveMerge">Save Merged</button>
<button id="shareBtn">Share via WhatsApp</button>
<button id="payBtn">Unlock Full Access</button>
<p id="licenseStatus" style="color: red;">🔒 License not active</p>





 <script>
window.addEventListener("load", () => {
  startTrialIfNeeded();
  checkLicense();
});

 if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js');
    });
  }
const video = document.getElementById("camera");
const canvas = document.getElementById("snapshot");
const ctx = canvas.getContext("2d");

const shadeLive = document.getElementById("liveShade");
const confidenceFill = document.getElementById("confidenceFill");

const regionSteps = {
  region: ["Incisal", "Middle", "Cervical"],
  merged: ["Prime", "Mesial", "Distal"]
};

let sessionData = {};
let patientName = "";
let currentMode = "single";

const webShades = {
  "A1":[206.3,213.6,205.6],"A2":[199.3,204.9,182.6],"A3":[193.5,198.4,165.1],
  "A3.5":[183.9,188.9,137.5],"A4":[160.6,166.3,115.1],"B1":[203.6,213.4,200.1],
  "B2":[208.2,212.2,190.1],"B3":[188.4,190.2,145.2],"B4":[191.4,194.9,140.5],
  "C1":[191.1,198.8,186.4],"C2":[186.3,189.9,161.5],"C3":[172.4,174.6,139.7],
  "C4":[147.8,154.4,107.8],"D2":[184.5,191.4,180.5],"D3":[179.8,183.7,163.7],
  "D4":[175.5,180.0,144.7]
};

setInterval(() => {
  const start = parseInt(localStorage.getItem(trialStartKey));
  const now = Date.now();
  const remaining = Math.max(0, TRIAL_DURATION_MS - (now - start));
  const minutes = Math.floor(remaining / 60000);
  const seconds = Math.floor((remaining % 60000) / 1000);
  document.getElementById("trialCountdown").textContent =
    `Trial time left: ${minutes}:${seconds.toString().padStart(2, "0")}`;
}, 1000);


function getAverageRGB(data) {
  const sum = [0, 0, 0];
  const count = data.length / 4;
  for (let i = 0; i < data.length; i += 4) {
    sum[0] += data[i];
    sum[1] += data[i + 1];
    sum[2] += data[i + 2];
  }
  return sum.map(v => v / count);
}

function rgbToLab([r, g, b]) {
  [r, g, b] = [r, g, b].map(v => {
    v /= 255;
    return v > 0.04045 ? Math.pow((v + 0.055) / 1.055, 2.4) : v / 12.92;
  });
  let x = (r * 0.4124 + g * 0.3576 + b * 0.1805) / 0.95047;
  let y = (r * 0.2126 + g * 0.7152 + b * 0.0722);
  let z = (r * 0.0193 + g * 0.1192 + b * 0.9505) / 1.08883;
  [x, y, z] = [x, y, z].map(v => v > 0.008856 ? Math.pow(v, 1 / 3) : (7.787 * v + 16 / 116));
  return [(116 * y) - 16, 500 * (x - y), 200 * (y - z)];
}

function findClosestShade(rgb) {
  const sampleLab = rgbToLab(rgb);
  let minDelta = Infinity, bestShade = "---";
  for (const shade in webShades) {
    const lab = rgbToLab(webShades[shade]);
    const delta = Math.sqrt(sampleLab.reduce((sum, v, i) => sum + Math.pow(v - lab[i], 2), 0));
    if (delta < minDelta) {
      minDelta = delta;
      bestShade = shade;
    }
  }
  return [bestShade, minDelta];
}

function captureShade(label, typeKey) {
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const r = 80;
  const roiX = canvas.width / 2;
  const roiY = canvas.height / 2;
  const data = ctx.getImageData(roiX - r, roiY - r, r * 2, r * 2).data;
  const avg = getAverageRGB(data);
  const [shade, delta] = findClosestShade(avg);

  sessionData.shades.push({
    [typeKey]: label,
    shade,
    deltaE: delta
  });

  shadeLive.textContent = `Shade: ${shade} | ${label}`;
  confidenceFill.textContent = `ΔE00: ${delta.toFixed(2)}`;
  confidenceFill.style.backgroundColor = delta < 3 ? "green" : delta < 6 ? "orange" : "red";
}

function saveJSONFile(filename) {
  const blob = new Blob([JSON.stringify(sessionData, null, 2)], { type: "application/json" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}

async function initiatePayment() {
  const deviceId = getDeviceId(); // your fingerprinting logic
  const orderId = `shade_${Date.now()}`;
  const amount = 499; // ₹499 or your chosen price

  try {
    const response = await fetch("/api/initiate-payment", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ orderId, amount, deviceId })
    });

    const data = await response.json();
    if (data.paymentUrl) {
      window.open(data.paymentUrl, "_blank");
    } else {
      alert("⚠️ Payment initiation failed. Please try again.");
    }
  } catch (err) {
    console.error("Payment error:", err);
    alert("🚫 Unable to connect to payment server.");
  }
}

document.getElementById("payBtn").onclick = initiatePayment;

const TRIAL_DURATION_MS = 15 * 60 * 1000; // 15 minutes
const trialStartKey = "shade_trial_start";

function startTrialIfNeeded() {
  if (!localStorage.getItem(trialStartKey)) {
    localStorage.setItem(trialStartKey, Date.now().toString());
  }
}
function getDeviceId() {
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  ctx.textBaseline = "top";
  ctx.font = "14px Arial";
  ctx.fillText("shade-detection", 2, 2);
  return canvas.toDataURL();
}
function activateLicense() {
  const deviceId = getDeviceId();
  localStorage.setItem("shade_license", "active");
  localStorage.setItem("shade_device_id", deviceId);
  localStorage.removeItem("shade_trial_start");
}
function isDeviceValid() {
  const storedId = localStorage.getItem("shade_device_id");
  return storedId === getDeviceId();
}


function isTrialActive() {
  const start = parseInt(localStorage.getItem(trialStartKey));
  const now = Date.now();
  return now - start < TRIAL_DURATION_MS;
}

function checkLicense() {
  const license = localStorage.getItem("shade_license") === "active" && isDeviceValid();

  const trial = isTrialActive();
  const allowed = license || trial;

  const statusEl = document.getElementById("licenseStatus");
  if (license) {
    statusEl.textContent = "✅ License active";
    statusEl.style.color = "green";
  } else if (trial) {
    statusEl.textContent = "🧪 Trial active";
    statusEl.style.color = "orange";
  } else {
    statusEl.textContent = "🔒 Trial expired. Please unlock full access.";
    statusEl.style.color = "red";
  }

  return allowed;
}



document.getElementById("saveSingle").onclick = () => {
  const name = document.getElementById("patientNameInput").value.trim();
  if (!name) return alert("Enter patient name before saving.");

  patientName = name;
  sessionData = {
    patientName,
    timestamp: new Date().toISOString(),
    mode: "single",
    shades: []
  };

  captureShade("Center ROI", "region");
  saveJSONFile(`${patientName}_single_shade.json`);
};

document.getElementById("saveRegion").onclick = async () => {
  const name = document.getElementById("patientNameInput").value.trim();
  if (!name) return alert("Enter patient name before saving.");

  patientName = name;
  sessionData = {
    patientName,
    timestamp: new Date().toISOString(),
    mode: "region",
    shades: []
  };

  for (const label of regionSteps.region) {
    alert(`📸 Place camera on ${label} third and click OK`);
    captureShade(label, "region");
  }

  saveJSONFile(`${patientName}_region_shade.json`);
};

document.getElementById("saveMerge").onclick = async () => {
  const name = document.getElementById("patientNameInput").value.trim();
  if (!name) return alert("Enter patient name before saving.");

  patientName = name;
  sessionData = {
    patientName,
    timestamp: new Date().toISOString(),
    mode: "merged",
    shades: []
  };

  for (const label of regionSteps.merged) {
    alert(`📸 Place camera on ${label} tooth and click OK`);
    captureShade(label, "toothPart");
  }

  saveJSONFile(`${patientName}_merged_shade.json`);
};

document.getElementById("shareBtn").onclick = () => {
  if (!sessionData || !sessionData.shades || sessionData.shades.length === 0) {
    return alert("Please save a session before sharing.");
  }

  const lines = sessionData.shades.map(s => {
    const key = s.region || s.toothPart || "ROI";
    return `${key}: ${s.shade} (ΔE00: ${s.deltaE.toFixed(2)})`;
  }).join("\n");

  const msg = `🦷 Tooth Shade Report\nPatient: ${sessionData.patientName}\nMode: ${sessionData.mode}\nTime: ${sessionData.timestamp}\n\n${lines}`;
  const number = "919949466397"; // replace as needed
  window.open(`https://wa.me/${number}?text=${encodeURIComponent(msg)}`, "_blank");
};

// Live camera preview loop
navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } }).then(stream => {
  video.srcObject = stream;
  video.addEventListener("loadeddata", () => {
    function drawLoop() {
  if (!checkLicense()) {
    shadeLive.textContent = "🔒 Trial expired";
    confidenceFill.textContent = "ΔE00: --";
    confidenceFill.style.backgroundColor = "gray";
    return; // Stop rendering
  }

  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const r = 80;
  const roiX = canvas.width / 2;
  const roiY = canvas.height / 2;
  const data = ctx.getImageData(roiX - r, roiY - r, r * 2, r * 2).data;
  const avg = getAverageRGB(data);
  const [shade, delta] = findClosestShade(avg);

  shadeLive.textContent = `Detected Shade: ${shade}`;
  confidenceFill.textContent = `ΔE00: ${delta.toFixed(2)}`;
  confidenceFill.style.backgroundColor = delta < 3 ? "green" : delta < 6 ? "orange" : "red";
  confidenceFill.style.width = Math.min(100, 100 - delta * 5) + "%";

  requestAnimationFrame(drawLoop);
}


    drawLoop(); // Start live shade monitoring
  
  });
});
</script>

</body>
</html>
